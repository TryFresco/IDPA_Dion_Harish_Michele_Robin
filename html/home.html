<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://cdn.maptiler.com/maptiler-geocoder/v1.1.0/maptiler-geocoder.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-geocoder/v1.1.0/maptiler-geocoder.css" rel="stylesheet" />
    <link rel="stylesheet" href="../css/home.css">

    <script>
        var orgn
        var dest
        var depD
        var retD
        var isTwoWayFlight = false
        var compensationCostPerKiloCo2 = 0.0426356 // according to co2.myclimate.org
        var compensationCosts

        function getCo2Emission() {
            orgn = String(document.querySelector("#orgArpt").value)
            dest = String(document.querySelector('#destArpt').value)
            depD = String(document.querySelector('#depDate').value)
            retD = String(document.querySelector('#retDate').value)

            if (orgn === "" || dest === "" || depD === "" || retD === "") {
                alert("Please fill in every field")
            } else {
                if (retD !== "") {
                    isTwoWayFlight = true
                }
                if (depD >= retD) {
                    alert("Retour date cannot be earlier than departure date")
                } else {

                    if (new Date().toISOString().slice(0, 10) > depD || new Date().toISOString().slice(0, 10) > retD) {
                        alert("Travel date cannot be earlier than current date.")
                    } else {

                        document.getElementById("emissionOutput").innerHTML = "loading..."
                        getNewToken()
                    }
                }
            }

        }


        function getNewToken() {
            var settings = {
                "url": "https://test.api.amadeus.com/v1/security/oauth2/token",
                "method": "POST",
                "timeout": 0,
                "headers": {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                "data": {
                    "grant_type": "client_credentials",
                    "client_id": "Yxs2IrBtYmbigUIpgFr5WaUnXLp7Njft",
                    "client_secret": "XNWRKO8Gw0cgLsGG"
                }
            };

            $.ajax(settings).done(function(response) {
                var obj = JSON.parse(JSON.stringify(response))
                var result = obj.access_token
                console.log(result)


                getFlightOffer(orgn.toUpperCase(), dest.toUpperCase(), depD, retD, result)
                    //getFlightOffer(toString(document.getElementById("orgArpt")), toString(document.getElementById("destArpt")), toString(document.getElementById("depDate")), toString(retD = document.getElementById("retDate")), result)
            });
        }

        function getFlightOffer(origin, destination, departureDate, returnDate, token) {
            console.log(origin)
            console.log(destination)
            console.log(departureDate)
            console.log(returnDate)
            var settings = {
                "url": "https://test.api.amadeus.com/v2/shopping/flight-offers?originLocationCode=" + origin + "&destinationLocationCode=" + destination + "&departureDate=" + departureDate + "&returnDate=" + returnDate + "&adults=1&max=3",
                "method": "GET",
                "timeout": 0,
                "headers": {
                    "Authorization": "Bearer " + token
                },
            };

            $.ajax(settings).done(function(response) {


                    var flightOfferData = response.data

                    console.log(flightOfferData)

                    flightOffersPricing(token, flightOfferData)

                    /*
                    var relevantData = response.data

                    return relevantData;
                    */
                })
                .fail(function(reponse, error) {
                    document.getElementById("emissionOutput").innerHTML = "Something went wrong, try again. Error: " + error
                });
        }


        function flightOffersPricing(token, data) {
            console.log(data)
            var settings = {
                "url": "https://test.api.amadeus.com/v1/booking/flight-orders",
                "method": "POST",
                "timeout": 0,
                "headers": {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                "data": JSON.stringify({
                    "data": {
                        "type": "flight-order",
                        "flightOffers": [
                            data[0]
                        ],

                        "travelers": [{
                            "id": "1",
                            "dateOfBirth": "2012-10-11",
                            "gender": "FEMALE",
                            "contact": {
                                "emailAddress": "jorge.gonzales833@telefonica.es",
                                "phones": [{
                                    "deviceType": "MOBILE",
                                    "countryCallingCode": "34",
                                    "number": "480080076"
                                }]
                            },
                            "name": {
                                "firstName": "ADRIANA",
                                "lastName": "GONZALES"
                            }
                        }],
                        "remarks": {
                            "general": [{
                                "subType": "GENERAL_MISCELLANEOUS",
                                "text": "ONLINE BOOKING FROM INCREIBLE VIAJES"
                            }]
                        },
                        "ticketingAgreement": {
                            "option": "DELAY_TO_CANCEL",
                            "delay": "6D"
                        },
                        "contacts": [{
                            "addresseeName": {
                                "firstName": "PABLO",
                                "lastName": "RODRIGUEZ"
                            },
                            "companyName": "INCREIBLE VIAJES",
                            "purpose": "STANDARD",
                            "phones": [{
                                "deviceType": "LANDLINE",
                                "countryCallingCode": "34",
                                "number": "480080071"
                            }, {
                                "deviceType": "MOBILE",
                                "countryCallingCode": "33",
                                "number": "480080072"
                            }],
                            "emailAddress": "support@increibleviajes.es",
                            "address": {
                                "lines": [
                                    "Calle Prado, 16"
                                ],
                                "postalCode": "28014",
                                "cityName": "Madrid",
                                "countryCode": "ES"
                            }
                        }]
                    }
                }),
            };

            $.ajax(settings).done(function(response) {
                console.log(response);
                var finalEmissions = response.data.flightOffers[0].itineraries[0].segments[0].co2Emissions[0].weight

                if (isTwoWayFlight == true) {
                    finalEmissions = finalEmissions * 2
                }
                console.log(finalEmissions)
                document.getElementById("emissionOutput").innerHTML = "CO2 Emissions for flight: " + finalEmissions + "kg" + "        Compenation costs: " + finalEmissions * compensationCostPerKiloCo2 + " CHF"
                document.getElementById("linkOutput").innerHTML = "https://www.myclimate.org/"
            })

            .fail(function(response) {
                document.getElementById("emissionOutput").innerHTML = "Request failed, there are no flights available for these dates. Choose other dates."
            })


        }

        function btnOnClick() {
            getCo2Emission()
        }

        // const btn = document.querySelector(".button");

        // btn.classList.add("button--loading");
        // btn.classList.remove("button--loading");
    </script>

    <title>Home</title>
</head>

<body>

    <div class="container">
        <div class="row">
            <div class="col-2"> </div>
            <div class="col-2">
                <input id="orgArpt" class="inputField" type="text" placeholder="Origin Airport">
            </div>

            <div class="col-2">
                <input id="destArpt" class="inputField" type="text" placeholder="Destination Airport">
            </div>

            <div class="col-2">
                <input id="depDate" class="inputField" type="date" placeholder="Departure Date">
            </div>
            <div class="col-2">
                <input id="retDate" class="inputField" type="date" placeholder="Retour Date">
            </div>
            <div class="col-2"> </div>
        </div>
        <br><br>
        <div class="row">
            <div class="col-5"></div>
            <div class="col-2">
                <p class="pText">*Please do only use 3-letter airport codes such as "ZRH", "SFO" or "LON"!</p>
            </div>
            <div class="col-5"></div>
        </div>
        <div class="row">
            <div class="col-5"></div>
            <div class="col-2">
                <button class="button-3 button__text" role="button " onclick="btnOnClick()">Calculate</button>
            </div>
            <div class="col-5"></div>
        </div>
        <br><br><br>
        <div class="row">
            <div class="col-5"></div>
            <div class="col-2">
                <p id="emissionOutput" class="pText"> </p>
            </div>
            <div class="col-5"></div>
        </div>
        <br>
        <div class="row">
            <div class="col-5"></div>
            <div class="col-2">
                <p id="linkOutput" type="link" class="pText"></p>
            </div>
            <div class="col-5"></div>
        </div>
    </div>

</body>

</html>